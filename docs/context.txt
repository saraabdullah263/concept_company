# نظام إدارة المخلفات الطبية - السياق الكامل للمشروع

## نظرة عامة

نظام إدارة المخلفات الطبية هو تطبيق ويب تقدمي (PWA) مصمم خصيصاً لشركات إدارة المخلفات الطبية لتنظيم وتتبع عمليات جمع ونقل وحرق المخلفات الطبية من المستشفيات إلى المحارق بشكل آمن ومنظم.

## المشكلة التي يحلها

المشكلة الأساسية التي تواجهها شركات المخلفات الطبية هي:
- **عدم وجود نظام منظم** لتتبع خطوط السير اليومية
- **صعوبة المراقبة** على السائقين والتأكد من التزامهم بالمسار
- **عدم دقة البيانات** المتعلقة بالكميات المجمعة من كل مستشفى
- **صعوبة المحاسبة** وإصدار الفواتير بناءً على الكميات الفعلية
- **مخاطر أمنية** بسبب عدم التوثيق الدقيق لعمليات النقل
- **عدم وجود تنبيهات** لانتهاء العقود مع المستشفيات

## الحل المقترح

نقوم ببناء تطبيق ويب تقدمي (PWA) يوفر:
1. **نظام إدارة خطوط السير** مع تتبع دقيق لكل مرحلة
2. **إدارة العملاء والعقود** مع تنبيهات تلقائية
3. **نظام محاسبة متكامل** (مدين/دائن/مصاريف)
4. **تقارير شاملة** للسائقين والرحلات والعملاء
5. **Dashboard تفاعلي** لمتابعة الأداء
6. **نظام صلاحيات متعدد المستويات**
7. **دعم العمل بدون إنترنت** (Offline Mode)

## التقنيات المستخدمة

### الواجهة الأمامية (Frontend)
- **React + Vite**: كإطار عمل حديث وسريع
- **Tailwind CSS**: للتصميم والتنسيق (مع دعم RTL)
- **React Router**: للتوجيه بين الصفحات
- **React Hook Form**: للنماذج والتحقق من البيانات
- **Lucide React**: للأيقونات
- **Recharts/Chart.js**: للرسوم البيانية والتقارير

### الواجهة الخلفية (Backend)
- **Supabase**: كخدمة Backend كخدمة (BaaS)
  - قاعدة بيانات PostgreSQL
  - نظام مصادقة المستخدمين
  - API جاهز للتعامل مع البيانات
  - سياسات الأمان (Row Level Security)
  - Edge Functions للعمليات الخادمية

### التخزين المحلي والـ Offline
- **IndexedDB**: لتخزين البيانات محلياً
- **Service Workers**: للعمل بدون اتصال
- **Workbox**: لإدارة الـ Cache والمزامنة

### النشر والتشغيل
- **Netlify**: لاستضافة التطبيق
- **PWA**: لتحويل التطبيق إلى تطبيق ويب تقدمي

## هيكل قاعدة البيانات

### الجداول الرئيسية

1. **users** (المستخدمون)
   - id (UUID)
   - full_name (نص)
   - email (بريد إلكتروني)
   - phone (رقم هاتف)
   - role (enum: admin, logistics_manager, accountant, representative, supervisor)
   - is_active (منطقي)
   - created_at (تاريخ ووقت)

2. **representatives** (المندوبين)
   - id (UUID)
   - user_id (مرجع للمستخدم)
   - license_number (رقم الترخيص)
   - license_expiry_date (تاريخ انتهاء الترخيص)
   - is_available (متاح حالياً)
   - created_at (تاريخ ووقت)

3. **hospitals** (المستشفيات/العملاء)
   - id (UUID)
   - name (اسم المستشفى)
   - address (العنوان)
   - contact_person (الشخص المسؤول)
   - contact_phone (رقم الهاتف)
   - contact_email (البريد الإلكتروني)
   - is_active (نشط)
   - created_at (تاريخ ووقت)

4. **contracts** (العقود)
   - id (UUID)
   - hospital_id (مرجع للمستشفى)
   - contract_number (رقم العقد - فريد)
   - start_date (تاريخ البداية)
   - end_date (تاريخ النهاية)
   - price_per_kg (السعر لكل كيلو)
   - alert_before_days (عدد الأيام للتنبيه قبل الانتهاء - افتراضي 90)
   - status (enum: active, expired, renewed, cancelled)
   - notes (ملاحظات)
   - attachments (مرفقات - JSON)
   - created_at (تاريخ ووقت)

5. **incinerators** (المحارق)
   - id (UUID)
   - name (اسم المحرقة)
   - location (الموقع)
   - capacity_per_day (الطاقة اليومية بالطن)
   - cost_per_kg (تكلفة الحرق لكل كيلو)
   - is_active (نشط)
   - created_at (تاريخ ووقت)

6. **routes** (خطوط السير)
   - id (UUID)
   - route_name (اسم خط السير)
   - representative_id (مرجع للمندوب)
   - incinerator_id (مرجع للمحرقة)
   - route_date (تاريخ الرحلة)
   - status (enum: pending, in_progress, completed, cancelled)
   - start_time (وقت البداية من الشركة)
   - start_location (موقع GPS عند البداية - JSON: {lat, lng})
   - estimated_start_time (الوقت التقديري للبداية)
   - estimated_duration_minutes (المدة التقديرية الإجمالية بالدقائق)
   - end_time (وقت الانتهاء)
   - end_location (موقع GPS عند الانتهاء - JSON: {lat, lng})
   - total_weight_collected (إجمالي الوزن المجمع بالكيلو)
   - final_weight_at_incinerator (الوزن النهائي في المحرقة)
   - supervisor_id (مرجع للمراقب الذي أغلق الرحلة)
   - closed_at (تاريخ ووقت الإغلاق)
   - is_delayed (هل الرحلة متأخرة)
   - delay_reason (سبب التأخير)
   - notes (ملاحظات)
   - created_at (تاريخ ووقت)

7. **route_stops** (محطات خط السير)
   - id (UUID)
   - route_id (مرجع لخط السير)
   - hospital_id (مرجع للمستشفى)
   - stop_order (ترتيب المحطة في الرحلة)
   - status (enum: pending, arrived, collected, skipped)
   - estimated_arrival_time (الوقت التقديري للوصول)
   - estimated_duration_minutes (المدة التقديرية في المحطة بالدقائق)
   - arrival_time (وقت الوصول الفعلي)
   - arrival_location (موقع GPS عند الوصول - JSON: {lat, lng})
   - departure_time (وقت المغادرة الفعلي)
   - departure_location (موقع GPS عند المغادرة - JSON: {lat, lng})
   - weight_collected (الوزن المجمع بالكيلو)
   - weight_entry_time (وقت إدخال الوزن)
   - weight_entry_location (موقع GPS عند إدخال الوزن - JSON: {lat, lng})
   - hospital_signature (التوقيع الإلكتروني - JSON)
   - signature_time (وقت التوقيع)
   - signature_location (موقع GPS عند التوقيع - JSON: {lat, lng})
   - photo_proof (صورة إثبات - URL)
   - photo_upload_time (وقت رفع الصورة)
   - photo_upload_location (موقع GPS عند رفع الصورة - JSON: {lat, lng})
   - is_delayed (هل المحطة متأخرة)
   - delay_minutes (عدد دقائق التأخير)
   - notes (ملاحظات)
   - created_at (تاريخ ووقت)

8. **route_tracking_logs** (سجل تتبع الرحلات)
   - id (UUID)
   - route_id (مرجع لخط السير)
   - route_stop_id (مرجع للمحطة - اختياري)
   - event_type (enum: route_started, arrived_hospital, departed_hospital, weight_entered, photo_uploaded, signature_taken, arrived_incinerator, route_completed)
   - event_time (وقت الحدث)
   - location (موقع GPS - JSON: {lat, lng, accuracy})
   - data (بيانات إضافية - JSON)
   - created_at (تاريخ ووقت)

9. **invoices** (الفواتير)
    - id (UUID)
    - invoice_number (رقم الفاتورة - فريد)
    - hospital_id (مرجع للمستشفى)
    - contract_id (مرجع للعقد)
    - invoice_date (تاريخ الفاتورة)
    - from_date (من تاريخ)
    - to_date (إلى تاريخ)
    - total_weight (إجمالي الوزن)
    - price_per_kg (السعر لكل كيلو)
    - subtotal (المجموع الفرعي)
    - tax (الضريبة)
    - total_amount (المبلغ الإجمالي)
    - status (enum: draft, sent, paid, overdue, cancelled)
    - due_date (تاريخ الاستحقاق)
    - paid_date (تاريخ السداد)
    - payment_method (طريقة الدفع)
    - notes (ملاحظات)
    - created_at (تاريخ ووقت)

10. **expenses** (المصاريف الداخلية)
    - id (UUID)
    - expense_type (enum: salaries, utilities, other)
    - description (الوصف)
    - amount (المبلغ)
    - expense_date (تاريخ المصروف)
    - category (الفئة)
    - reference_id (مرجع اختياري - للربط بسجل آخر)
    - approved_by (تمت الموافقة من قبل)
    - notes (ملاحظات)
    - created_at (تاريخ ووقت)

11. **incinerator_transactions** (معاملات المحرقة)
    - id (UUID)
    - route_id (مرجع لخط السير)
    - incinerator_id (مرجع للمحرقة)
    - weight (الوزن بالكيلو)
    - cost_per_kg (التكلفة لكل كيلو)
    - total_cost (التكلفة الإجمالية)
    - transaction_date (تاريخ المعاملة)
    - receipt_number (رقم الإيصال)
    - notes (ملاحظات)
    - created_at (تاريخ ووقت)

12. **notifications** (الإشعارات)
    - id (UUID)
    - user_id (مرجع للمستخدم)
    - title (العنوان)
    - message (الرسالة)
    - type (enum: contract_expiry, route_assigned, route_completed, invoice_overdue, delay_alert)
    - is_read (مقروء)
    - related_id (معرف العنصر المرتبط)
    - related_type (نوع العنصر المرتبط)
    - created_at (تاريخ ووقت)

13. **user_activity_logs** (سجل نشاطات المستخدمين - اختياري)
    - id (UUID)
    - user_id (مرجع للمستخدم)
    - action_type (enum: login, logout, create, update, delete, view)
    - entity_type (نوع الكيان: route, invoice, user, etc.)
    - entity_id (معرف الكيان)
    - description (وصف النشاط)
    - ip_address (عنوان IP)
    - user_agent (متصفح المستخدم)
    - created_at (تاريخ ووقت)

## واجهة المستخدم

### الصفحات الرئيسية

1. **لوحة التحكم (Dashboard)**
   - إحصائيات سريعة:
     - عدد الرحلات النشطة اليوم
     - **عدد الرحلات المتأخرة** (مع مؤشر أحمر)
     - إجمالي الوزن المجمع هذا الشهر
     - عدد العقود القريبة من الانتهاء
   - رسم بياني للكميات المجمعة (يومي/أسبوعي/شهري)
   - رسم بياني للإيرادات vs المصاريف
   - **رسم بياني لمعدلات الالتزام بالمواعيد**
   - قائمة بالرحلات النشطة حالياً مع:
     - **الحالة الحالية** (في الطريق، في محطة)
     - **مؤشر التأخير** (أخضر/أصفر/أحمر)
     - **آخر موقع مسجل** والوقت
     - **المحطة الحالية/القادمة**
   - تنبيهات مهمة:
     - **رحلات متأخرة** (عاجل)
     - عقود قريبة من الانتهاء
     - رخص السائقين قريبة من الانتهاء

2. **العملاء والعقود**
   - **المستشفيات**:
     - قائمة المستشفيات
     - إضافة/تعديل مستشفى
     - عرض تفاصيل المستشفى (العقود، الرحلات، الفواتير)
   
   - **العقود**:
     - قائمة العقود (نشطة، منتهية، ملغاة)
     - إضافة/تعديل عقد
     - رفع مرفقات العقد
     - تنبيهات انتهاء العقود (حسب المدة المحددة)
     - تجديد العقد

3. **خطوط السير**
   - **إنشاء خط سير جديد**:
     - اختيار السائق
     - اختيار المستشفيات (بالترتيب)
     - اختيار المحرقة
     - تحديد تاريخ الرحلة
   
   - **قائمة خطوط السير**:
     - فلترة حسب (التاريخ، الحالة، السائق)
     - عرض تفاصيل الرحلة
     - تتبع حالة الرحلة
   
   - **تطبيق السائق** (واجهة مبسطة):
     - عرض خط السير المخصص
     - **عرض الأوقات التقديرية** لكل محطة
     - **مؤشر الحالة**: في الوقت المحدد / متأخر
     - زر "بدء الرحلة" (يسجل وقت البداية + موقع GPS)
     - قائمة المستشفيات بالترتيب مع:
       - الوقت التقديري للوصول
       - المدة التقديرية في المحطة
     - لكل مستشفى:
       - زر "وصلت" (يسجل وقت الوصول + موقع GPS)
       - **عرض التأخير** إن وجد
       - إدخال الوزن المجمع (يسجل وقت الإدخال + موقع GPS)
       - رفع صورة إثبات (يسجل وقت الرفع + موقع GPS)
       - التوقيع الإلكتروني (يسجل وقت التوقيع + موقع GPS)
       - زر "مغادرة" (يسجل وقت المغادرة + موقع GPS)
       - **عرض المدة الفعلية** في المحطة
     - المحرقة (المحطة الأخيرة):
       - زر "وصلت المحرقة" (يسجل وقت + موقع GPS)
       - إدخال الوزن النهائي (يسجل وقت + موقع GPS)
       - زر "إنهاء الرحلة" (يسجل وقت + موقع GPS)
     - **إشعارات فورية** عند التأخير
     - **طلب سبب التأخير** إذا كان كبيراً

   - **مراجعة الرحلات** (للمراقب):
     - قائمة الرحلات المكتملة (بانتظار المراجعة)
     - عرض تفاصيل الرحلة كاملة:
       - **Timeline كامل** للرحلة مع الأوقات والمواقع
       - **خريطة المسار** (سيتم لاحقاً) تعرض جميع المواقع المسجلة
       - مقارنة الأوقات الفعلية vs التقديرية
       - **تقرير التأخيرات** (إن وجدت) مع الأسباب
       - مراجعة الأوزان من كل محطة
       - الوزن النهائي في المحرقة
       - **التحقق من المواقع**: هل كانت صحيحة؟
       - عرض الصور مع وقت ومكان التقاطها
       - عرض التوقيعات مع وقت ومكان التوقيع
       - **سجل كامل** لكل الأحداث (route_tracking_logs)
     - إضافة ملاحظات
     - زر "إغلاق الرحلة" (يغير الحالة إلى مكتمل)

4. **المحاسبة**
   - **نظرة عامة**:
     - رصيد الحسابات (مدين/دائن)
     - الإيرادات الشهرية
     - المصاريف الشهرية
     - صافي الربح
   
   - **الفواتير** (دائن - المستشفيات):
     - قائمة الفواتير (مسودة، مرسلة، مدفوعة، متأخرة)
     - إنشاء فاتورة تلقائياً (بناءً على الرحلات)
     - إنشاء فاتورة يدوياً
     - تعديل الفاتورة
     - طباعة/تصدير الفاتورة (PDF)
     - تسجيل الدفع
     - إرسال تذكير للعميل
   
   - **معاملات المحرقة** (مدين):
     - قائمة المعاملات
     - عرض التكاليف حسب المحرقة
     - تقارير شهرية للتكاليف
   
   - **المصاريف الداخلية**:
     - قائمة المصاريف
     - إضافة مصروف جديد
     - تصنيف المصاريف (رواتب، مرافق، أخرى)
     - تقارير المصاريف حسب الفئة

5. **التقارير**
   - **تقارير العملاء**:
     - تقرير مالي شهري لكل عميل
     - الكميات المجمعة
     - الفواتير المصدرة والمدفوعة
     - المتأخرات
     - مقارنة بين العملاء
   
   - **تقارير السائقين**:
     - عدد الرحلات لكل سائق
     - **معدل الالتزام بالمواعيد** (نسبة مئوية)
     - **متوسط التأخير** لكل سائق
     - **عدد مرات التأخير** (بسيط/متوسط/كبير)
     - **أسباب التأخيرات** الشائعة
     - الكميات المجمعة
     - **متوسط وقت كل محطة**
     - **تقييم الأداء العام**
     - مقارنة الأداء بين السائقين
   
   - **تقارير الرحلات**:
     - إجمالي الرحلات (يومي/أسبوعي/شهري)
     - **نسبة الرحلات في الوقت المحدد** vs المتأخرة
     - **متوسط التأخير** للرحلات
     - **تحليل أسباب التأخيرات**
     - الكميات المجمعة
     - متوسط وقت الرحلة (فعلي vs تقديري)
     - **متوسط وقت كل محطة**
     - **المحطات الأكثر تأخيراً**
     - تكلفة كل رحلة
     - الإيرادات من كل رحلة
     - صافي الربح
     - **كفاءة الرحلات** (الوقت الفعلي / الوقت التقديري)
   
   - **تقارير مالية**:
     - قائمة الدخل (شهري/سنوي)
     - الإيرادات vs المصاريف
     - تحليل الربحية
     - التدفق النقدي

6. **إدارة المستخدمين** (للـ Admin فقط)
   - **قائمة المستخدمين**:
     - عرض جميع المستخدمين
     - فلترة حسب الدور (admin, logistics_manager, accountant, representative, supervisor)
     - فلترة حسب الحالة (نشط/معطل)
     - البحث بالاسم أو البريد الإلكتروني
   
   - **إضافة مستخدم جديد**:
     - الاسم الكامل (مطلوب)
     - البريد الإلكتروني (مطلوب - فريد)
     - رقم الهاتف (مطلوب)
     - كلمة المرور (مطلوب)
     - **اختيار الدور** (مطلوب):
       * Admin - صلاحيات كاملة
       * Logistics Manager - إدارة خطوط السير
       * Accountant - المحاسبة والفواتير
       * Supervisor - مراجعة الرحلات
       * Representative - تنفيذ الرحلات
     - الحالة (نشط/معطل)
     - **إذا كان Representative**:
       * رقم الترخيص (مطلوب)
       * تاريخ انتهاء الترخيص (مطلوب)
   
   - **تعديل مستخدم**:
     - تعديل المعلومات الأساسية
     - **تغيير الدور** (مع تحذير)
     - تغيير كلمة المرور
     - تفعيل/تعطيل الحساب
     - **إذا كان Representative**:
       * تحديث معلومات الترخيص
       * تغيير الحالة (متاح/غير متاح)
   
   - **حذف مستخدم**:
     - تحذير قبل الحذف
     - التحقق من عدم وجود رحلات نشطة (للسائقين)
     - أرشفة البيانات بدلاً من الحذف الفعلي
   
   - **عرض تفاصيل المستخدم**:
     - المعلومات الأساسية
     - الدور والصلاحيات
     - تاريخ الإنشاء
     - آخر تسجيل دخول
     - **إذا كان Representative**:
       * عدد الرحلات المنفذة
       * معدل الالتزام بالمواعيد
       * حالة الترخيص
     - **إذا كان Supervisor**:
       * عدد الرحلات المراجعة
     - سجل النشاطات (اختياري)

7. **الإعدادات**
   - **إعدادات النظام**:
     - معلومات الشركة
     - إعدادات الفواتير (الضريبة، شروط الدفع)
     - إعدادات التنبيهات
     - النسخ الاحتياطي

### المكونات الرئيسية

- **Header**: الشريط العلوي مع الإشعارات وملف المستخدم
- **Sidebar**: الشريط الجانبي للتنقل (مع دعم RTL)
- **RouteCard**: بطاقة خط السير مع الحالة والتقدم ومؤشر التأخير
- **ContractCard**: بطاقة العقد مع تنبيه الانتهاء
- **InvoiceCard**: بطاقة الفاتورة مع الحالة
- **StatsCard**: بطاقة الإحصائيات في Dashboard
- **DataTable**: جدول بيانات قابل للفلترة والترتيب
- **DateRangePicker**: اختيار نطاق التاريخ للتقارير
- **SignaturePad**: لوحة التوقيع الإلكتروني
- **ImageUploader**: رفع الصور مع تسجيل الموقع
- **NotificationBell**: جرس الإشعارات
- **OfflineIndicator**: مؤشر حالة الاتصال
- **LocationTracker**: مكون لتتبع الموقع وتسجيله
- **DelayIndicator**: مؤشر التأخير (أخضر/أصفر/أحمر)
- **RouteTimeline**: عرض Timeline للرحلة مع الأوقات والمواقع
- **DelayAlert**: تنبيه التأخير للسائق
- **EstimatedTimeDisplay**: عرض الأوقات التقديرية vs الفعلية

## الأدوار والصلاحيات

### 1. Admin (المدير العام)
- **صلاحيات كاملة** على جميع الأقسام
- **إدارة المستخدمين**:
  - إضافة/تعديل/حذف المستخدمين
  - تعيين وتغيير الأدوار والصلاحيات
  - تفعيل/تعطيل الحسابات
  - عرض سجل نشاطات المستخدمين
- عرض جميع التقارير
- إعدادات النظام

### 2. Logistics Manager (مشرف اللوجستيات)
- إنشاء وتعديل خطوط السير
- عرض تقارير الرحلات
- **لا يمكنه**: الوصول للمحاسبة أو إدارة المستخدمين

### 3. Accountant (المحاسب)
- عرض وإدارة الفواتير
- تسجيل المدفوعات
- إدارة المصاريف
- عرض جميع التقارير المالية
- **لا يمكنه**: إدارة خطوط السير

### 4. Representative (المندوب)
- عرض خط السير المخصص له فقط
- تحديث حالة الرحلة (وصول، مغادرة)
- إدخال الأوزان
- رفع الصور
- **لا يمكنه**: الوصول لأي قسم آخر

### 5. Supervisor (المراقب)
- مراجعة الرحلات المكتملة
- إغلاق خطوط السير
- عرض تقارير الرحلات
- **لا يمكنه**: إنشاء رحلات أو الوصول للمحاسبة

## سير العمل (Workflow)

### 1. إنشاء خط سير جديد
```
مشرف اللوجستيات → إنشاء خط سير
  ↓
اختيار: سائق + تاريخ
  ↓
إضافة المستشفيات بالترتيب
  ↓
اختيار المحرقة (المحطة الأخيرة)
  ↓
حفظ → يرسل إشعار للسائق
```

### 2. تنفيذ الرحلة (من السائق)
```
السائق يفتح التطبيق
  ↓
يرى خط السير المخصص له (مع الأوقات التقديرية)
  ↓
يضغط "بدء الرحلة" → يسجل:
  - وقت البداية الفعلي
  - موقع GPS الحالي
  - يُرسل للنظام فوراً
  - يُقارن بالوقت التقديري
  - إذا متأخر → إشعار للسائق والمشرف
  ↓
لكل مستشفى:
  - يضغط "وصلت" → يسجل:
    * وقت الوصول الفعلي
    * موقع GPS الحالي
    * يُقارن بالوقت التقديري
    * إذا متأخر → إشعار
  
  - يدخل الوزن المجمع → يسجل:
    * الوزن
    * وقت الإدخال
    * موقع GPS الحالي
  
  - يرفع صورة (اختياري) → يسجل:
    * الصورة
    * وقت الرفع
    * موقع GPS الحالي
  
  - يأخذ توقيع المسؤول → يسجل:
    * التوقيع
    * وقت التوقيع
    * موقع GPS الحالي
  
  - يضغط "مغادرة" → يسجل:
    * وقت المغادرة الفعلي
    * موقع GPS الحالي
    * يحسب المدة في المحطة
    * يُقارن بالمدة التقديرية
    * إذا متأخر → إشعار
  ↓
في المحرقة:
  - يضغط "وصلت المحرقة" → يسجل:
    * وقت الوصول
    * موقع GPS
  
  - يدخل الوزن النهائي → يسجل:
    * الوزن
    * وقت الإدخال
    * موقع GPS
  
  - يضغط "إنهاء الرحلة" → يسجل:
    * وقت الانتهاء
    * موقع GPS
  ↓
الحالة تتغير إلى "مكتمل" → يرسل إشعار للمراقب
  ↓
جميع البيانات (الأوقات والمواقع) محفوظة في قاعدة البيانات
```

### 3. مراجعة وإغلاق الرحلة (من المراقب)
```
المراقب يرى إشعار رحلة مكتملة
  ↓
يفتح تفاصيل الرحلة
  ↓
يراجع:
  - الأوقات (بداية، وصول، مغادرة، نهاية)
  - الأوزان من كل مستشفى
  - الوزن النهائي في المحرقة
  - الصور والتوقيعات
  ↓
إذا كل شيء صحيح:
  - يضيف ملاحظات (اختياري)
  - يضغط "إغلاق الرحلة"
  ↓
الحالة تتغير إلى "مغلق"
  ↓
تُنشأ معاملة محرقة تلقائياً (مدين)
  ↓
تُحدث بيانات الفواتير للمستشفيات (دائن)
```

### 4. إصدار الفواتير (من المحاسب)
```
المحاسب يختار فترة (شهر مثلاً)
  ↓
يختار مستشفى
  ↓
النظام يجمع تلقائياً:
  - جميع الرحلات المغلقة في الفترة
  - الأوزان المجمعة من هذا المستشفى
  - السعر من العقد
  ↓
يُنشئ الفاتورة تلقائياً
  ↓
المحاسب يراجع ويعدل إذا لزم
  ↓
يحفظ ويرسل للعميل
  ↓
عند الدفع: يسجل الدفع وتاريخه
```

## نظام التتبع والمراقبة في الوقت الفعلي

### المبدأ الأساسي
**كل إجراء يقوم به السائق يُسجل مع:**
1. الوقت الدقيق للإجراء
2. موقع GPS الحالي (خط الطول والعرض)
3. دقة الموقع (Accuracy)

### الأحداث المتتبعة

1. **بداية الرحلة**:
   - الوقت الفعلي vs الوقت التقديري
   - الموقع (يجب أن يكون قريب من موقع الشركة)

2. **الوصول لكل مستشفى**:
   - الوقت الفعلي vs الوقت التقديري
   - الموقع (يجب أن يكون قريب من موقع المستشفى)
   - حساب التأخير تلقائياً

3. **إدخال الوزن**:
   - الوقت والموقع
   - التحقق من أن الموقع لا يزال في المستشفى

4. **رفع الصورة**:
   - الوقت والموقع
   - ربط الصورة بالموقع

5. **التوقيع الإلكتروني**:
   - الوقت والموقع
   - التحقق من صحة الموقع

6. **المغادرة من المستشفى**:
   - الوقت الفعلي
   - الموقع
   - حساب المدة الإجمالية في المحطة

7. **الوصول للمحرقة**:
   - الوقت والموقع
   - التحقق من الموقع

8. **إنهاء الرحلة**:
   - الوقت والموقع النهائي

### نظام الأوقات التقديرية

عند إنشاء خط السير، يقوم المشرف بتحديد:

1. **وقت البداية التقديري**: مثلاً 8:00 صباحاً
2. **لكل محطة**:
   - الوقت التقديري للوصول: مثلاً 8:30 صباحاً
   - المدة التقديرية في المحطة: مثلاً 15 دقيقة
3. **المدة الإجمالية التقديرية**: مثلاً 4 ساعات

### نظام كشف التأخير

**التأخير يُحسب تلقائياً:**

```
تأخير = الوقت الفعلي - الوقت التقديري
```

**مستويات التأخير:**
- **تأخير بسيط** (5-15 دقيقة): تنبيه للسائق فقط
- **تأخير متوسط** (15-30 دقيقة): تنبيه للسائق + إشعار للمشرف
- **تأخير كبير** (أكثر من 30 دقيقة): تنبيه عاجل للسائق + إشعار للمشرف + طلب توضيح السبب

**الإشعارات التلقائية:**
- عند تجاوز الوقت التقديري → إشعار فوري للسائق
- عند التأخير المتوسط → إشعار للمشرف
- عند التأخير الكبير → طلب من السائق كتابة سبب التأخير

### لوحة المراقبة في الوقت الفعلي

**للمشرف:**
- خريطة تعرض موقع كل عربية نشطة (سيتم لاحقاً)
- قائمة بالرحلات النشطة مع:
  - الحالة الحالية (في الطريق، في محطة، متأخر)
  - الوقت المتوقع للوصول للمحطة القادمة
  - مؤشر التأخير (أخضر/أصفر/أحمر)
  - آخر موقع مسجل
  - آخر حدث (مع الوقت)

### فوائد نظام التتبع

1. **الشفافية الكاملة**: كل إجراء موثق بالوقت والموقع
2. **المساءلة**: لا يمكن التلاعب بالبيانات
3. **الأمان**: التأكد من أن السائق في الموقع الصحيح
4. **الكفاءة**: كشف التأخيرات مبكراً
5. **التحليل**: بيانات دقيقة لتحسين الأداء
6. **حل النزاعات**: دليل موثق لكل رحلة

## نظام الإشعارات

### أنواع الإشعارات

1. **إشعارات خطوط السير**
   - تعيين رحلة جديدة للسائق
   - اكتمال رحلة (للمراقب)
   - **تأخير في بداية الرحلة** (إذا لم يبدأ في الوقت المحدد)
   - **تأخير في الوصول لمحطة** (إذا تجاوز الوقت التقديري)
   - **تأخير في المغادرة من محطة** (إذا تجاوز المدة التقديرية)
   - **تنبيه للسائق** عند التأخير
   - **تنبيه للمشرف** عند التأخير الكبير (أكثر من 30 دقيقة مثلاً)

2. **إشعارات العقود**
   - تنبيه قبل انتهاء العقد (حسب المدة المحددة)
   - انتهاء عقد

3. **إشعارات الرخص**
   - اقتراب انتهاء رخصة السائق
   - انتهاء رخصة السائق

4. **إشعارات الفواتير**
   - فاتورة جديدة
   - فاتورة متأخرة السداد
   - استلام دفعة

## أذونات التطبيق المطلوبة

### للسائقين (تطبيق PWA):

1. **Location Permission (إذن الموقع)**:
   - **مطلوب**: نعم (إلزامي)
   - **النوع**: High Accuracy GPS
   - **الاستخدام**: تسجيل الموقع مع كل إجراء
   - **الخصوصية**: المواقع تُستخدم فقط لتوثيق الرحلات

2. **Camera Permission (إذن الكاميرا)**:
   - **مطلوب**: نعم (اختياري)
   - **الاستخدام**: التقاط صور إثبات

3. **Storage Permission (إذن التخزين)**:
   - **مطلوب**: نعم
   - **الاستخدام**: حفظ البيانات محلياً (Offline Mode)

4. **Notification Permission (إذن الإشعارات)**:
   - **مطلوب**: نعم
   - **الاستخدام**: إشعارات التأخير والتنبيهات

### كيفية طلب الأذونات:

1. **عند أول تسجيل دخول للسائق**:
   - شرح واضح لماذا نحتاج كل إذن
   - طلب الأذونات واحد تلو الآخر
   - توضيح أن الموقع ضروري لعمل التطبيق

2. **إذا رفض السائق إذن الموقع**:
   - رسالة توضح أن التطبيق لن يعمل بدونه
   - خيار لإعادة طلب الإذن

3. **التحقق من الأذونات**:
   - قبل بدء كل رحلة، التأكد من تفعيل GPS
   - تنبيه إذا كان GPS معطل

## Offline Mode (وضع عدم الاتصال)

### المشكلة
السائقون قد يفقدون الاتصال بالإنترنت أثناء الرحلة (مناطق نائية، أنفاق، إلخ)

### الحل
- **Service Workers**: للتعامل مع الطلبات بدون اتصال
- **IndexedDB**: لتخزين البيانات محلياً
- **Queue System**: لحفظ العمليات وإرسالها عند عودة الاتصال

### كيف يعمل؟

1. **عند فتح التطبيق (مع اتصال)**:
   - يحمل خط السير المخصص للسائق
   - يخزنه في IndexedDB
   - يخزن بيانات المستشفيات المطلوبة

2. **أثناء الرحلة (بدون اتصال)**:
   - السائق يستطيع:
     - عرض خط السير
     - تحديث الحالات
     - إدخال الأوزان
     - رفع الصور (تُخزن محلياً)
   - جميع التغييرات تُحفظ في IndexedDB
   - تُضاف إلى Queue للمزامنة

3. **عند عودة الاتصال**:
   - Service Worker يكتشف الاتصال
   - يبدأ بمزامنة البيانات من Queue
   - يرسل التحديثات إلى Supabase
   - يرفع الصور المحفوظة
   - يحذف البيانات المزامنة من IndexedDB

4. **مؤشر الحالة**:
   - أيقونة في الشريط العلوي تظهر حالة الاتصال
   - عداد للعمليات المعلقة

## خطة التنفيذ

### المرحلة الأولى: الإعداد الأساسي (3-4 أيام)
1. إعداد مشروع React + Vite
2. تكوين Tailwind CSS مع دعم RTL
3. إعداد Supabase وإنشاء قاعدة البيانات
4. إنشاء الجداول والعلاقات
5. إعداد Row Level Security (RLS)
6. إعداد PWA الأساسي

### المرحلة الثانية: المصادقة والهيكل (3-4 أيام)
1. نظام المصادقة مع Supabase
2. إدارة الأدوار والصلاحيات
3. إنشاء Layout الأساسي (Header, Sidebar)
4. نظام التوجيه (React Router)
5. إدارة الحالة (Context API)

### المرحلة الثالثة: العملاء والعقود (3-4 أيام)
1. صفحة المستشفيات (CRUD)
2. صفحة العقود (CRUD)
3. رفع مرفقات العقود
4. نظام التنبيهات للعقود
5. حساب الأيام المتبقية

### المرحلة الرابعة: خطوط السير (5-6 أيام)
1. صفحة إنشاء خط سير
2. إضافة المحطات بالترتيب
3. صفحة قائمة خطوط السير
4. واجهة السائق المبسطة
5. تحديث حالة المحطات
6. إدخال الأوزان
7. رفع الصور
8. التوقيع الإلكتروني
9. صفحة مراجعة الرحلات (للمراقب)
10. إغلاق الرحلة

### المرحلة الخامسة: المحاسبة (5-6 أيام)
1. صفحة نظرة عامة على الحسابات
2. صفحة الفواتير (CRUD)
3. إنشاء فاتورة تلقائياً من الرحلات
4. طباعة/تصدير الفاتورة (PDF)
5. تسجيل الدفعات
6. صفحة معاملات المحرقة
7. ربط الرحلات بمعاملات المحرقة
8. صفحة المصاريف الداخلية (CRUD)
9. تصنيف المصاريف

### المرحلة السادسة: التقارير (4-5 أيام)
1. تقارير العملاء:
   - تقرير مالي شهري
   - الكميات والفواتير
2. تقارير السائقين:
   - الأداء والالتزام
   - استهلاك الوقود
3. تقارير الرحلات:
   - إحصائيات شاملة
   - تحليل التكاليف والإيرادات
4. تقارير مالية:
   - قائمة الدخل
   - التدفق النقدي
6. تصدير التقارير (PDF/Excel)

### المرحلة السابعة: Dashboard (3-4 أيام)
1. بطاقات الإحصائيات
2. الرسوم البيانية (Recharts)
3. قائمة الرحلات النشطة
4. التنبيهات المهمة
5. تحديث البيانات في الوقت الفعلي

### المرحلة الثامنة: Offline Mode (4-5 أيام)
1. إعداد Service Workers
2. إعداد IndexedDB
3. نظام Queue للعمليات المعلقة
4. المزامنة التلقائية
5. مؤشر حالة الاتصال
6. اختبار السيناريوهات المختلفة

### المرحلة التاسعة: الإشعارات والإعدادات (3-4 أيام)
1. نظام الإشعارات داخل التطبيق
2. جرس الإشعارات
3. صفحة الإعدادات
4. إدارة المستخدمين (للـ Admin)
5. إعدادات النظام
6. إعدادات الفواتير

### المرحلة العاشرة: التحسينات والاختبار (4-5 أيام)
1. تحسين الأداء
2. تحسين تجربة المستخدم
3. اختبار جميع الميزات
4. اختبار الصلاحيات
5. اختبار Offline Mode
6. إصلاح الأخطاء
7. تحسين التصميم

### المرحلة الحادية عشر: النشر (2-3 أيام)
1. إعداد Netlify
2. تكوين متغيرات البيئة
3. النشر التجريبي
4. الاختبار على الإنتاج
5. النشر النهائي
6. التوثيق

## هيكل الملفات

```
medical-waste-management/
├── public/
│   ├── manifest.json
│   ├── sw.js (Service Worker)
│   ├── icons/
│   └── offline.html
├── src/
│   ├── components/
│   │   ├── common/
│   │   │   ├── Header.jsx
│   │   │   ├── Sidebar.jsx
│   │   │   ├── Loading.jsx
│   │   │   ├── NotificationBell.jsx
│   │   │   ├── OfflineIndicator.jsx
│   │   │   └── DataTable.jsx
│   │   ├── auth/
│   │   │   ├── LoginForm.jsx
│   │   │   └── ProtectedRoute.jsx
│   │   ├── users/
│   │   │   ├── UserList.jsx
│   │   │   ├── UserCard.jsx
│   │   │   ├── UserForm.jsx
│   │   │   ├── RoleSelector.jsx
│   │   │   └── UserStats.jsx
│   │   ├── contracts/
│   │   │   ├── HospitalList.jsx
│   │   │   ├── HospitalForm.jsx
│   │   │   ├── ContractList.jsx
│   │   │   └── ContractForm.jsx
│   │   ├── routes/
│   │   │   ├── RouteList.jsx
│   │   │   ├── RouteForm.jsx
│   │   │   ├── RouteCard.jsx
│   │   │   ├── RepresentativeRouteView.jsx
│   │   │   ├── StopCard.jsx
│   │   │   └── RouteReview.jsx
│   │   ├── accounting/
│   │   │   ├── InvoiceList.jsx
│   │   │   ├── InvoiceForm.jsx
│   │   │   ├── InvoiceCard.jsx
│   │   │   ├── ExpenseList.jsx
│   │   │   ├── ExpenseForm.jsx
│   │   │   └── IncineratorTransactions.jsx
│   │   ├── reports/
│   │   │   ├── CustomerReports.jsx
│   │   │   ├── RepresentativeReports.jsx
│   │   │   ├── RouteReports.jsx
│   │   │   ├── FleetReports.jsx
│   │   │   └── FinancialReports.jsx
│   │   └── ui/
│   │       ├── StatsCard.jsx
│   │       ├── DateRangePicker.jsx
│   │       ├── SignaturePad.jsx
│   │       └── ImageUploader.jsx
│   ├── context/
│   │   ├── AuthContext.jsx
│   │   ├── RouteContext.jsx
│   │   ├── NotificationContext.jsx
│   │   └── OfflineContext.jsx
│   ├── hooks/
│   │   ├── useAuth.js
│   │   ├── useUsers.js
│   │   ├── useRoutes.js
│   │   ├── useContracts.js
│   │   ├── useInvoices.js
│   │   ├── useOffline.js
│   │   └── useNotifications.js
│   ├── services/
│   │   ├── supabase.js
│   │   ├── authService.js
│   │   ├── userService.js
│   │   ├── representativeService.js
│   │   ├── hospitalService.js
│   │   ├── contractService.js
│   │   ├── routeService.js
│   │   ├── locationService.js (تتبع الموقع)
│   │   ├── trackingService.js (تسجيل الأحداث)
│   │   ├── delayDetectionService.js (كشف التأخير)
│   │   ├── invoiceService.js
│   │   ├── expenseService.js
│   │   ├── reportService.js
│   │   ├── notificationService.js
│   │   └── offlineService.js
│   ├── utils/
│   │   ├── constants.js
│   │   ├── helpers.js
│   │   ├── dateUtils.js
│   │   ├── formatters.js
│   │   ├── validators.js
│   │   └── pdfGenerator.js
│   ├── pages/
│   │   ├── Dashboard.jsx
│   │   ├── Login.jsx
│   │   ├── users/
│   │   │   ├── Users.jsx
│   │   │   ├── UserForm.jsx
│   │   │   └── UserDetails.jsx
│   │   ├── contracts/
│   │   │   ├── Hospitals.jsx
│   │   │   └── Contracts.jsx
│   │   ├── routes/
│   │   │   ├── Routes.jsx
│   │   │   ├── CreateRoute.jsx
│   │   │   ├── RepresentativeRoute.jsx
│   │   │   └── ReviewRoutes.jsx
│   │   ├── accounting/
│   │   │   ├── Overview.jsx
│   │   │   ├── Invoices.jsx
│   │   │   ├── Expenses.jsx
│   │   │   └── IncineratorTransactions.jsx
│   │   ├── reports/
│   │   │   └── Reports.jsx
│   │   └── settings/
│   │       └── Settings.jsx
│   ├── styles/
│   │   ├── globals.css
│   │   └── rtl.css
│   ├── App.jsx
│   └── main.jsx
├── package.json
├── vite.config.js
├── tailwind.config.js
├── netlify.toml
└── README.md
```

## المتطلبات الأساسية

### البرامج المطلوبة
- Node.js (الإصدار 18 أو أحدث)
- Git
- محرر أكواد (VS Code مفضل)

### الحسابات المطلوبة
- حساب Supabase (مجاني)
- حساب Netlify (مجاني)

## معايير الجودة

1. **كود نظيف ومنظم**:
   - لا يزيد الملف عن 300 سطر
   - استخدام مكونات قابلة لإعادة الاستخدام
   - تسميات واضحة ومعبرة

2. **توثيق جيد**:
   - كل مكون ووظيفة موثقة
   - تعليقات بالعربية للوضوح

3. **تصميم متجاوب**:
   - يعمل على جميع الأحجام (موبايل، تابلت، ديسكتوب)
   - دعم كامل للـ RTL

4. **أمان**:
   - Row Level Security في Supabase
   - التحقق من الصلاحيات في كل عملية
   - تشفير البيانات الحساسة

5. **أداء**:
   - تحميل سريع
   - Lazy Loading للصفحات
   - تحسين الصور
   - Caching ذكي

6. **تجربة المستخدم**:
   - واجهة بسيطة وسهلة
   - رسائل خطأ واضحة
   - تأكيدات للعمليات المهمة
   - Loading states

## المخاطر المحتملة والحلول

### 1. مشاكل الاتصال أثناء الرحلة
**الحل**: Offline Mode مع مزامنة تلقائية

### 2. فقدان البيانات
**الحل**: 
- حفظ تلقائي
- نسخ احتياطي يومي
- سجل تدقيق لكل العمليات

### 3. أخطاء في إدخال الأوزان
**الحل**:
- التحقق من صحة البيانات
- مقارنة الوزن في المستشفى مع الوزن في المحرقة
- تنبيه إذا كان الفرق كبير

### 4. تعارض البيانات عند المزامنة
**الحل**:
- Timestamp لكل عملية
- آخر تحديث يفوز (Last Write Wins)
- سجل للتعارضات للمراجعة

### 5. صعوبة الاستخدام للسائقين
**الحل**:
- واجهة مبسطة جداً للسائق
- أزرار كبيرة وواضحة
- تعليمات خطوة بخطوة
- تدريب قبل الاستخدام

## الجدول الزمني التقديري

- **الأسبوع 1-2**: المراحل 1-2 (الإعداد، المصادقة)
- **الأسبوع 3**: المرحلة 3 (العقود)
- **الأسبوع 4-5**: المرحلة 4 (خطوط السير)
- **الأسبوع 6**: المرحلة 5 (المحاسبة)
- **الأسبوع 7**: المرحلة 6 (التقارير)
- **الأسبوع 8**: المرحلة 7 (Dashboard)
- **الأسبوع 9**: المرحلة 8 (Offline)
- **الأسبوع 10**: المرحلة 9 (الإشعارات والإعدادات)
- **الأسبوع 11**: المرحلة 10 (التحسينات والاختبار)
- **الأسبوع 12**: المرحلة 11 (النشر)

**إجمالي الوقت المتوقع**: 10-12 أسبوع

## معايير النجاح

1. ✅ **جميع الوظائف الأساسية تعمل بشكل كامل**
2. ✅ **السائق يستطيع تنفيذ الرحلة بدون اتصال**
3. ✅ **المراقب يستطيع مراجعة وإغلاق الرحلات**
4. ✅ **المحاسب يستطيع إصدار الفواتير تلقائياً**
5. ✅ **التقارير دقيقة وشاملة**
6. ✅ **التنبيهات تعمل بشكل صحيح**
7. ✅ **الصلاحيات محكمة وآمنة**
8. ✅ **واجهة سريعة ومتجاوبة**
9. ✅ **دعم كامل للغة العربية والـ RTL**
10. ✅ **نشر ناجح على Netlify**

## ميزات إضافية (مستقبلية - خارج النطاق الحالي)

### المرحلة الثانية (بعد الإطلاق الأول):
1. **تكامل GPS/Maps**:
   - تتبع موقع العربية في الوقت الفعلي
   - رسم المسار الفعلي على الخريطة
   - تحسين المسارات تلقائياً

2. **Portal للمستشفيات**:
   - المستشفى تسجل دخول
   - تشاهد الرحلات القادمة
   - تشاهد الفواتير
   - تحمل التقارير

3. **أنواع مخلفات متعددة**:
   - تصنيف المخلفات (معدية، كيميائية، حادة)
   - أسعار مختلفة لكل نوع
   - تقارير حسب النوع

4. **تطبيق موبايل Native**:
   - تطبيق Android/iOS
   - أداء أفضل
   - إشعارات Push

5. **ذكاء اصطناعي**:
   - توقع الكميات
   - اقتراح خطوط سير محسنة
   - كشف الأنماط غير الطبيعية

6. **تكامل مع أنظمة محاسبية**:
   - تصدير للأنظمة المحاسبية
   - مزامنة تلقائية

## الخطوات التالية

بعد الموافقة على هذا السياق، سنبدأ في:

1. **إنشاء Spec كامل** للمشروع باستخدام نظام Kiro
2. **تنظيم هيكل المشروع** (إنشاء المجلدات)
3. **إعداد Supabase** وإنشاء قاعدة البيانات
4. **إعداد مشروع React + Vite**
5. **تنفيذ الميزات** حسب الخطة المرحلية

---

هذا السياق الكامل يوفر فهماً شاملاً للمشروع وأهدافه والتقنيات المستخدمة وخطة التنفيذ التفصيلية. يمكن الرجوع إليه في أي مرحلة من مراحل المشروع للتأكد من الالتزام بالخطة الموضوعة.

**تاريخ الإنشاء**: ديسمبر 2024
**الإصدار**: 1.0
**اللغة**: العربية
**النوع**: PWA (Progressive Web App)

---

## ملاحظات مهمة عن نظام التتبع

### الخصوصية والأمان:
1. **المواقع تُسجل فقط أثناء الرحلات النشطة**
2. **لا يتم تتبع السائق خارج أوقات العمل**
3. **البيانات مشفرة ومحمية**
4. **الوصول محدود حسب الصلاحيات**

### الدقة والموثوقية:
1. **استخدام High Accuracy GPS** للحصول على أدق موقع
2. **تسجيل دقة الموقع** (Accuracy) مع كل قراءة
3. **التحقق من صحة المواقع** (مثلاً: هل الموقع قريب من المستشفى؟)
4. **حفظ البيانات محلياً** في حالة انقطاع الاتصال

### التعامل مع الأخطاء:
1. **إذا فشل الحصول على الموقع**: 
   - محاولة مرة أخرى
   - تنبيه السائق
   - السماح بالمتابعة مع تسجيل الخطأ

2. **إذا كان الموقع غير دقيق**:
   - تسجيل الموقع مع ملاحظة الدقة المنخفضة
   - تنبيه المراقب عند المراجعة

3. **إذا كان GPS معطل**:
   - منع بدء الرحلة
   - طلب تفعيل GPS

### الأداء:
1. **تسجيل الموقع فقط عند الأحداث** (وليس بشكل مستمر)
2. **تقليل استهلاك البطارية**
3. **ضغط البيانات** قبل الإرسال
4. **المزامنة الذكية** عند توفر الاتصال

### الامتثال القانوني:
1. **إعلام السائقين** بنظام التتبع
2. **الحصول على موافقة** قبل التفعيل
3. **الالتزام بقوانين الخصوصية**
4. **حق السائق في الاطلاع** على بياناته
